# DocumentaciÃ³n de Implementaciones en `cparque` (06/02/2025)

## 1ï¸âƒ£ **ModificaciÃ³n de la Base de Datos**

### âœ… **ConversiÃ³n del Campo `codigo` a INT en `clientes`**
Se realizÃ³ una modificaciÃ³n en la base de datos para cambiar el tipo de dato del campo `codigo` en la tabla `clientes` de `VARCHAR(50)` a `BIGINT UNSIGNED`.

### ğŸ”§ **SQL Ejecutado en MariaDB/MySQL**
```sql
-- Eliminar la restricciÃ³n UNIQUE temporalmente
ALTER TABLE clientes DROP INDEX clientes_codigo_unique;

-- Convertir el campo 'codigo' de VARCHAR a BIGINT UNSIGNED
ALTER TABLE clientes MODIFY codigo BIGINT UNSIGNED NOT NULL;

-- Restaurar la restricciÃ³n UNIQUE
ALTER TABLE clientes ADD UNIQUE (codigo);
```

### ğŸ”¥ **ActualizaciÃ³n del Modelo `Cliente.php`**
Para asegurar que Laravel maneje `codigo` como un entero, se agregÃ³ lo siguiente en `app/Models/Cliente.php`:
```php
protected $casts = [
    'codigo' => 'integer',
];
```

---

## 2ï¸âƒ£ **GeneraciÃ³n AutomÃ¡tica de `codigo` Basado en el PenÃºltimo Valor**

Se modificÃ³ el formulario de **Filament** para que el campo `codigo`:
- Se incremente segÃºn el penÃºltimo cÃ³digo existente.
- Se pueda modificar manualmente sin perder unicidad.

### ğŸ”§ **CÃ³digo Modificado en `ClienteResource.php`**
```php
Forms\Components\TextInput::make('codigo')
    ->label('CÃ³digo')
    ->required()
    ->numeric() // Asegura que solo acepte nÃºmeros
    ->default(function () {
        $penultimoCodigo = \App\Models\Cliente::orderByDesc('codigo')
            ->skip(1) // Salta el Ãºltimo cÃ³digo
            ->value('codigo');

        return $penultimoCodigo ? $penultimoCodigo + 1 : 1; // Si no hay penÃºltimo, empieza desde 1
    })
    ->unique(ignoreRecord: true) // Evita duplicados en la validaciÃ³n de Filament
    ->reactive()
    ->afterStateUpdated(fn ($state, callable $set) => $set('codigo', trim($state))); // Limpia espacios extras
```

---

## 3ï¸âƒ£ **ActualizaciÃ³n de `cliente_id` en `parcelas` y AsignaciÃ³n AutomÃ¡tica de `nivel` en `inhumados`**

Se modificÃ³ el proceso de creaciÃ³n de clientes para que:
- **`cliente_id` se asigne a la tabla `parcelas`** al guardar un nuevo cliente.
- **Los inhumados se registren en la misma parcela** con su correspondiente nivel (`primer_nivel`, `segundo_nivel`, `tercer_nivel`).

### ğŸ”§ **CÃ³digo Modificado en `CreateCliente.php`**
```php
protected function handleRecordCreation(array $data): Model
{
    $cliente = \DB::transaction(function () use ($data) {
        // 1ï¸âƒ£ Crear el cliente
        $cliente = \App\Models\Cliente::create($data);

        // 2ï¸âƒ£ Actualizar la parcela asignÃ¡ndole el cliente_id
        if (!empty($data['parcela_id'])) {
            \App\Models\Parcela::where('id', $data['parcela_id'])
                ->update(['cliente_id' => $cliente->id]);
        }

        // 3ï¸âƒ£ Insertar inhumados con el nivel calculado
        if (!empty($data['inhumados'])) {
            foreach ($data['inhumados'] as $inhumado) {
                // Obtener el nivel basado en la cantidad de inhumados en la parcela
                $cantidadInhumados = \App\Models\Inhumado::where('parcela_id', $data['parcela_id'])->count();

                $niveles = ['primer_nivel', 'segundo_nivel', 'tercer_nivel'];
                $nivel = $cantidadInhumados < 3 ? $niveles[$cantidadInhumados] : 'tercer_nivel'; // MÃ¡ximo tercer nivel

                // Insertar el inhumado con el nivel calculado
                \App\Models\Inhumado::create([
                    'cliente_id' => $cliente->id,
                    'parcela_id' => $data['parcela_id'],
                    'nivel' => $nivel,
                    'nombre' => $inhumado['nombre'],
                    'apellido' => $inhumado['apellido'],
                    'fecha_nacimiento' => $inhumado['fecha_nacimiento'] ?? '1970-01-01',
                    'fecha_inhumacion' => $inhumado['fecha_inhumacion'],
                ]);
            }
        }

        return $cliente; // Retorna el cliente creado dentro de la transacciÃ³n
    });

    // 4ï¸âƒ£ NotificaciÃ³n de Ã©xito
    Notification::make()
        ->title('Cliente creado con Ã©xito')
        ->success()
        ->send();

    return $cliente; // Retorna el cliente fuera de la transacciÃ³n
}
```

---

## 4ï¸âƒ£ **Resultados y Beneficios**
âœ” **El campo `codigo` se gestiona de forma inteligente y flexible.**
âœ” **Se actualiza correctamente `cliente_id` en `parcelas` al crear un cliente.**
âœ” **Los inhumados se asignan a la misma parcela con un nivel correcto.**
âœ” **Todo se ejecuta en una transacciÃ³n, asegurando consistencia de datos.**
âœ” **Laravel y Filament trabajan de manera fluida sin conflictos de unicidad.**

---

ğŸ“Œ **Este commit incluye:**
- Cambio de tipo de `codigo` a INT en `clientes`.
- GeneraciÃ³n del penÃºltimo `codigo`.
- ActualizaciÃ³n de `cliente_id` en `parcelas`.
- AsignaciÃ³n automÃ¡tica de `nivel` en `inhumados`.

ğŸš€ **Sistema funcionando correctamente. Listo para la siguiente fase.**

